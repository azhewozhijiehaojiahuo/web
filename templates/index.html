<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Optimal Sample Selector Pro</title>
    <link rel="stylesheet" href="{{ url_for('static', filename='style.css') }}">
</head>
<body>
    <div class="header">
        <h1>Optimal Sample Selection</h1>
    </div>
    <div class="control-panel">
        <h2>Parameters Configuration</h2>
        <div class="control-row">
            <label for="m">m (45-54):</label>
            <select id="m" name="m">
                {% for i in range(45, 55) %}
                    <option value="{{ i }}">{{ i }}</option>
                {% endfor %}
            </select>
        </div>
        <div class="control-row">
            <label for="n">n (7-25):</label>
            <select id="n" name="n">
                {% for i in range(7, 26) %}
                    <option value="{{ i }}">{{ i }}</option>
                {% endfor %}
            </select>
        </div>
        <div class="control-row">
            <label for="k">k (4-7):</label>
            <select id="k" name="k" onchange="update_j_s()">
                {% for i in range(4, 8) %}
                    <option value="{{ i }}">{{ i }}</option>
                {% endfor %}
            </select>
        </div>
        <div class="control-row">
            <label for="j">j (s<=j<=k):</label>
            <select id="j" name="j" onchange="update_s()" disabled></select>
        </div>
        <div class="control-row">
            <label for="s">s (3-7):</label>
            <select id="s" name="s" disabled></select>
        </div>
        <div class="mode-selection">
            <input type="radio" id="random" name="mode" value="random" onclick="update_mode()">
            <label for="random">Random n</label>
            <input type="radio" id="manual" name="mode" value="manual" onclick="update_mode()" checked>
            <label for="manual">Manual Input</label>
        </div>
        <input type="text" id="manual_input" name="manual_input" placeholder="Enter samples">
    </div>
    <div class="button-panel">
        <button id="generate_btn" onclick="generate_n()">Generate</button>
        <button id="execute_btn" onclick="execute()">Execute</button>
        <button id="save_btn" onclick="store_to_db()" disabled>Save</button>
        <button id="view_btn" onclick="toggle_db_view()">View DB</button>
    </div>
    <div class="result-panel">
        <h2>Results Display</h2>
        <ul id="result_listbox"></ul>
    </div>
    <div id="db_frame" class="db-panel" style="display: none;">
        <table id="db_table">
            <thead>
                <tr>
                    <th>Filename</th>
                    <th>Execution Time (s)</th>
                    <th>Combinations</th>
                </tr>
            </thead>
            <tbody></tbody>
        </table>
        <div id="context_menu" class="context-menu" style="display: none;">
            <a href="#" onclick="preview_record()">Preview</a>
            <a href="#" onclick="validate_selected()">Validate</a>
            <a href="#" onclick="delete_selected()">Delete</a>
        </div>
    </div>

    <script>
        function update_j_s() {
            const k = parseInt(document.getElementById('k').value);
            const j_select = document.getElementById('j');
            j_select.innerHTML = '';
            for (let i = 3; i <= k; i++) {
                const option = document.createElement('option');
                option.value = i;
                option.textContent = i;
                j_select.appendChild(option);
            }
            j_select.disabled = false;
            update_s();
        }

        function update_s() {
            const j = parseInt(document.getElementById('j').value);
            const s_select = document.getElementById('s');
            s_select.innerHTML = '';
            for (let i = 3; i <= Math.min(7, j); i++) {
                const option = document.createElement('option');
                option.value = i;
                option.textContent = i;
                s_select.appendChild(option);
            }
            s_select.disabled = false;
        }

        function update_mode() {
            const mode = document.querySelector('input[name="mode"]:checked').value;
            const n_select = document.getElementById('n');
            if (mode === 'random') {
                n_select.disabled = true;
            } else {
                n_select.disabled = false;
            }
        }

        function generate_n() {
            const m = document.getElementById('m').value;
            const mode = document.querySelector('input[name="mode"]:checked').value;
            const n = document.getElementById('n').value;
            const data = {m: m, mode: mode, n: n};
            fetch('/generate_n', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/x-www-form-urlencoded'
                },
                body: new URLSearchParams(data)
            })
           .then(response => response.json())
           .then(data => {
                if (data.error) {
                    alert(data.error);
                } else {
                    const manual_input = document.getElementById('manual_input');
                    manual_input.value = data.samples;
                    if (mode === 'random') {
                        manual_input.disabled = true;
                    }
                    show_generated_samples();
                }
            });
        }

        function show_generated_samples() {
            const result_listbox = document.getElementById('result_listbox');
            result_listbox.innerHTML = '';
            const samples = document.getElementById('manual_input').value.split(' ');
            samples.forEach((val, idx) => {
                const li = document.createElement('li');
                li.textContent = `sample${idx + 1}: ${val}`;
                result_listbox.appendChild(li);
            });
        }

        function execute() {
            const k = document.getElementById('k').value;
            const j = document.getElementById('j').value;
            const s = document.getElementById('s').value;
            const manual_input = document.getElementById('manual_input').value;
            const data = {k: k, j: j, s: s, manual_input: manual_input};
            const generate_btn = document.getElementById('generate_btn');
            const execute_btn = document.getElementById('execute_btn');
            const save_btn = document.getElementById('save_btn');
            const view_btn = document.getElementById('view_btn');
            generate_btn.disabled = true;
            execute_btn.disabled = true;
            save_btn.disabled = true;
            view_btn.disabled = true;
            const result_listbox = document.getElementById('result_listbox');
            result_listbox.innerHTML = '<li>Calculating, please wait...</li>';
            fetch('/execute', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/x-www-form-urlencoded'
                },
                body: new URLSearchParams(data)
            })
           .then(response => response.json())
           .then(data => {
                generate_btn.disabled = false;
                execute_btn.disabled = false;
                view_btn.disabled = false;
                result_listbox.innerHTML = '';
                if (data.success) {
                    data.result.forEach(result => {
                        const li = document.createElement('li');
                        li.textContent = result;
                        result_listbox.appendChild(li);
                    });
                    save_btn.disabled = false;
                    alert(`找到${data.result.length - 1}个组合`);
                } else {
                    alert(data.error);
                }
            });
        }

        function store_to_db() {
            const m = document.getElementById('m').value;
            const k = document.getElementById('k').value;
            const j = document.getElementById('j').value;
            const s = document.getElementById('s').value;
            const manual_input = document.getElementById('manual_input').value;
            const result_listbox = document.getElementById('result_listbox');
            const solution = [];
            let execution_time = 0;
            for (let i = 0; i < result_listbox.children.length - 1; i++) {
                const text = result_listbox.children[i].textContent;
                const group = text.split(': ')[1];
                solution.push(group);
            }
            execution_time = parseFloat(result_listbox.children[result_listbox.children.length - 1].textContent.split(': ')[1].replace('秒', ''));
            const data = {m: m, k: k, j: j, s: s, manual_input: manual_input, solution: JSON.stringify(solution), execution_time: execution_time};
            fetch('/store_to_db', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/x-www-form-urlencoded'
                },
                body: new URLSearchParams(data)
            })
           .then(response => response.json())
           .then(data => {
                if (data.error) {
                    alert(data.error);
                } else {
                    alert(data.message);
                    if (document.getElementById('db_frame').style.display === 'block') {
                        load_db_records();
                    }
                }
            });
        }

        function toggle_db_view() {
            const db_frame = document.getElementById('db_frame');
            if (db_frame.style.display === 'none') {
                db_frame.style.display = 'block';
                load_db_records();
            } else {
                db_frame.style.display = 'none';
            }
        }

        function load_db_records() {
            const db_table = document.getElementById('db_table').getElementsByTagName('tbody')[0];
            db_table.innerHTML = '';
            fetch('/load_db_records')
           .then(response => response.json())
           .then(data => {
                data.records.forEach(record => {
                    const row = db_table.insertRow();
                    const filenameCell = row.insertCell(0);
                    const timeUsedCell = row.insertCell(1);
                    const countCell = row.insertCell(2);
                    filenameCell.textContent = record.filename;
                    timeUsedCell.textContent = record.time_used;
                    countCell.textContent = record.count;
                    row.addEventListener('contextmenu', function(event) {
                        event.preventDefault();
                        const context_menu = document.getElementById('context_menu');
                        context_menu.style.left = event.pageX + 'px';
                        context_menu.style.top = event.pageY + 'px';
                        context_menu.style.display = 'block';
                        window.selected_filename = record.filename;
                    });
                });
            });
        }

        function preview_record() {
            const filename = window.selected_filename;
            const data = {filename: filename};
            fetch('/preview_record', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/x-www-form-urlencoded'
                },
                body: new URLSearchParams(data)
            })
           .then(response => response.json())
           .then(data => {
                if (data.error) {
                    alert(data.error);
                } else {
                    const preview = window.open('', '_blank');
                    preview.document.write(`<pre>${data.combinations}</pre>`);
                }
            });
            document.getElementById('context_menu').style.display = 'none';
        }

        function validate_selected() {
            const filename = window.selected_filename;
            const data = {filename: filename};
            fetch('/validate_selected', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/x-www-form-urlencoded'
                },
                body: new URLSearchParams(data)
            })
           .then(response => response.json())
           .then(data => {
                if (data.error) {
                    alert(data.error);
                } else {
                    alert(data.message);
                }
            });
            document.getElementById('context_menu').style.display = 'none';
        }

        function delete_selected() {
            if (confirm('确定删除选中记录？')) {
                const filename = window.selected_filename;
                const data = {filename: filename};
                fetch('/delete_selected', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/x-www-form-urlencoded'
                    },
                    body: new URLSearchParams(data)
                })
               .then(response => response.json())
               .then(data => {
                    if (data.error) {
                        alert(data.error);
                    } else {
                        alert(data.message);
                        load_db_records();
                    }
                });
            }
            document.getElementById('context_menu').style.display = 'none';
        }

        window.addEventListener('click', function() {
            document.getElementById('context_menu').style.display = 'none';
        });
    </script>
</body>
</html>